---
title: 快如閃電的vite
description: >-
  或許你曾經有過這樣的經驗，專案採用webpack開發，一開始bundle的速度還算快，但時間一久，隨著專案的增長，套件的相依關係變得越來越冗長，能明顯感受到webpack…
date: '2022-02-02T08:02:49.079Z'
categories: []
keywords: []
slug: /@joe-chang/%E5%BF%AB%E5%A6%82%E9%96%83%E9%9B%BB%E7%9A%84vite-3b1915dbecd
---

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__H21jmBDu0AmjMUR1Swy7rw.png)

或許你曾經有過這樣的經驗，專案採用webpack開發，一開始bundle的速度還算快，但時間一久，隨著專案的增長，套件的相依關係變得越來越冗長，能明顯感受到webpack bundle速度越來越緩慢，改了一個小地方卻要等上好幾秒才能看到網頁畫面更新，而vite就是為了解決這個問題而誕生的! vite 採用ES Module 的方式，不需要提前做bundle，讓瀏覽器發出request來跟dev server請求需要的module，因此即使dependency(第三方套件)變多，vite的熱更新也不會有延遲的問題，啟動的速度也是輾壓webpack

**甚麼是bundle?**

> 將專案中所有的module(模組)編譯成一隻JavaScript檔案

webpack必須將全部有相依關係的module先處理過一次，bundle好之後再由瀏覽器載入js，如下圖的main.js，因此要等上一段時間才能看到畫面更新

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__2y__b5__CN8dZZVa3oMJ5zOg.png)
![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__mv__MhxHr__NPTzHJpxXztUg.png)

而vite是利用ES Module來載入套件，所以會有很多request依序加載，也就是把載入module的工作丟給瀏覽器來處理

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__icUCnOykhvRdBcVLSY9ABQ.png)
![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__kWpt9qxZcuBZShvkxf__zHA.png)

除了ES Module，esbuild也是讓vite提升速度的一大功臣，esbuild會將第三方套件預先構建好（Dependency Pre-Bundling），將Dependency整合在同一個module，減少網路的request，另外，vite dev server會將所有的module視作ES module，因此套件格式為CommonJS或是UMD的，esbuild會統一轉成 ES Modules的格式

**為甚麼可以這麼快?**

> Vite 将会使用 [esbuild](https://esbuild.github.io/) [预构建依赖](https://cn.vitejs.dev/guide/dep-pre-bundling.html)。 [esbuild](https://esbuild.github.io/) 使用 **Go** 编写，并且比以 JavaScript 编写的打包器预构建依赖快 10–100 倍。(引用自vite官網)

看看esbuild這鬼神一般的速度…

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__JS3gFsv2vIsHOFMRhrWRZg.png)

#### 變快真的很有感?

以一個全新的專案來說，採用的前端框架如果為vue的感受比較細微，使用vue cli(webpack)和 vite所建立的專案，兩者跑dev server的速度差異不大，但React就很有感了，以近期開發的React專案來說，剛開始是用create-React-app (webpack)建立的，光一個空白專案的bundle速度就非常慢，最後慢到大家都受不了，因此決定改用vite，雖然那時也是左思右想，擔心vite還不夠穩定，不過想說剛出的vite 2.0版本，有做大幅度的優化，就大膽的用在工作上的專案了(很小很小的專案)，習慣vite之後，再回去使用webpack會很不習慣那個速度😂，這裡有個比較速度的[影片](https://twitter.com/swyx/status/1290410811802804226)我覺得很有趣，分享給大家

#### 關於vite打包

vite採用rollup進行打包，不過這邊的行為模式就跟webpack相差無幾了，為甚麼vite還是需要經過打包，不能像開發模式那樣靠瀏覽器載入需要的模組呢?

1.  因為發佈的程式碼是放在伺服器上，每個使用者打開網頁都會發出好幾個請求，伺服器的負擔會大大增加，這肯定行不通
2.  上線版本還是需要對程式碼做一些優化處理，例如lazy load、tree-shaking等等

#### vite起來!

接下來實際來體驗vite有多快吧!要注意的是，vite需要的node版本必須**大於 12.0.0**，如果版本太低要先記得升級，因為我習慣用yarn，所以使用yarn來安裝vite ，也可以用npm或是pnpm安裝

```
$ yarn create vite
```

執行完上述指令，就會詢問專案名稱以及要使用的框架為何，vite不只支援vue，react、svelte等等的前端框架都可以，可說是海納百川😂，這邊先選擇React

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__hmc0__Gy2yTBBirwLmXmX3w.png)
![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__7KCfGNPbHLJkSs8yBnjykQ.png)

選好框架後，會詢問是否要建立typeScript版本，這裡先選擇一般版本，選好版本後專案以迅雷不及掩耳的速度建立完成

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__3lLM4JonF0tdRxrwuHqohg.png)

執行yarn dev會發現dev server馬上就起好了，修改檔案也是一存檔，就跟著熱更新(HMR)

> 假設有a, b, c三個模組，只有c模組更新，那麼只會重新編譯c，a和b直接從快取拿編譯結果，就不需要全部的模組都重新編譯，這就是為甚麼vite的熱更新並不會因為套件變多而變慢

專案建好之後，可以在根目錄底下看到vite.config.js

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__FBP4__a0IamxH4fVKAugbnA.png)

我們可以在vite.config.js撰寫打包相關設定

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__ynFGtdssHGC69bBCxDmscQ.png)

接下來會介紹個人常使用到的vite設定

**plugins**

要引入的套件import完之後，必須寫在plugins的陣列裡

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__C0qkUMCcGSGH1T9ZupE7ew.png)

**讀取env的變數**

在webpack中，我們只要寫上process.env.xxx就能取到我們要的環境變數，但是在vite.config.js中，這樣寫是取不到值的，必須額外引入loadEnv這個套件，export default改為一個return defineConfig的函式，並且傳入mode參數

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__Yfc1u7brsKAI5__qvN72h8g.png)

**設置別名**

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__nrCerQOQAerHSYWUDB9YpA.png)

**dev server 相關設定**

假設 port不想用預設的3000，則可以設定成其他的port

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__hEvXjvqA2xsKlVK5bs7Z7A.png)

**複製檔案並且移動到指定位置**

將檔案複製到指定資料夾並且更換檔名，設定hook可以更改複製的時機

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__Jc6sL8C0e4ixDe6TNsgnCg.png)

**全域引入scss變數**

可以全域引入多個scss，這樣就不需要每個檔案都引入scss變數了

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__9tote5BLRgUT__SsI6QSQ8A.png)

**打包時檔案分類**

vite打包的時候js、 css、素材都會在同一個資料夾底下，雖然不影響功能運作，但是看起來不夠清爽，假設要像之前webpack打包那樣將檔案依類型分類就可以這樣設定

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__8ueAvaW6ZR4xKXClZ6UX9Q.png)

**套件大小分析工具(rollup-plugin-visualizer)**

專案上線後發現網頁載入速度過慢，就需要幫js瘦身，因此需要工具來幫我們分析套件的大小，每次打包會生成 stats.html，打開 stats.html，哪個套件最肥一目了然

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__xXy5uR6__JGx7buryBkTwAw.png)
![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1____dppngxWou1Fk93ctfvGPA.png)

不過說實話我個人還是比較喜歡webpack的套件分析工具就是了😂

![](/Users/joectchang_mac/Downloads/medium-export-a/post2022/md_1697073583233/img/1__dusVhPiL44VDoS4gJHMWSg.gif)

#### 跳槽vite之前有哪些顧慮?

1.  **支援度** — 舊瀏覽器的支援度一直都是都是讓人頭疼的問題，那些不支援ES Modules的瀏覽器該怎麼辦呢 ? 可以透過 [@vitejs/plugin-legacy](https://link.juejin.cn/?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Fvitejs%2Fvite%2Ftree%2Fmain%2Fpackages%2Fplugin-legacy "https://link.zhihu.com/?target=https%3A//github.com/vitejs/vite/tree/main/packages/plugin-legacy") 套件來處理相容性的問題，不過為了因為多了向下相容的程式碼，所以打包出來的檔案會變蠻大的
2.  **套件的豐富度** — vite可以相容rollup現有的套件，雖然數量不如webpack那麼多，不過也是綽綽有餘了
3.  **穩定度** —我想這應該是所有人對vite最有疑慮的一點了，不得不說 vite目前還是有蠻多bug的，我用vite開發的時候的確也遇到不少問題，所以如果要用在工作的專案的話，必須在開發效率和穩定度之間做出取捨

#### 從webpack跳過來vite要習慣甚麼?

假設要在env檔裡面設置環境變數，記得變數名稱要是VITE(大寫)開頭，不然就會被忽略 ex. VITE\_APP\_HOST，以vue cli來說，假如要在.vue檔或是.js檔中讀取環境變數會是用process.env.VUE\_APP\_HOST，而在vite裡面就會變成import.meta.env.VITE\_APP\_HOST

#### 結論

在這個分秒必爭的時代，vite有效的提升了開發的效率，不是一點點，而是非常有感的提升，也難怪vite 的slogan會寫著 **Next Generation Fronted Tooling**，如果你從未用過vite，非常推薦你玩看看，至於要不要用在工作的專案上，大部分的人還是持保留態度，畢竟vite還很年輕，穩定度一定不比行之有年的webpack，究竟vite能否會取代webpack成為下個世代的前端開發工具呢 ? 這部分就留給時間去做驗證了

參考資料

[Vite官網](https://vitejs.dev/)

[Vite 怎麼能那麼快？從 ES modules 開始談起](https://blog.huli.tw/2020/08/07/vite-and-esmodules/)